<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Report an Ocean Hazard — OceanSense</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="assets/css/report.css">
</head>

<body>

<header class="site-header">
  <div class="container header-inner d-flex align-items-center justify-content-between">
    <a href="index.html" class="brand d-flex align-items-center text-decoration-none">
      <img src="assets/images/logo.png" class="logo" alt="OceanSense logo">
      <span class="brand-name">Ocean<span class="brand-accent">Sense</span></span>
    </a>
  </div>
</header>

<main class="py-5">
<div class="container">
<div class="report-card">
<div class="report-left">

<h1 class="report-title">Report an Ocean Hazard</h1>
<p class="muted">Share photos, location and severity so local authorities can respond quickly.</p>

<form id="reportForm" enctype="multipart/form-data" novalidate>

<div class="field">
  <label>Title *</label>
  <input name="title" id="title" required>
  <div class="field-msg" id="msg-title"></div>
</div>

<div class="field">
  <label>Description *</label>
  <textarea name="description" id="description" required></textarea>
  <div class="field-msg" id="msg-description"></div>
</div>

<div class="row gx-2">
  <div class="col-sm-6 field">
    <label>Latitude *</label>
    <input name="lat" id="lat" required>
    <div class="field-msg" id="msg-lat"></div>
  </div>
  <div class="col-sm-6 field">
    <label>Longitude *</label>
    <input name="lon" id="lon" required>
    <div class="field-msg" id="msg-lon"></div>
  </div>
</div>

<div class="field">
  <label>Severity</label>
  <input type="range" id="severity" min="0" max="2" value="0">
</div>

<div class="field">
  <label>Photo (optional)</label>
  <input type="file" id="photo" name="photo" accept="image/*">
</div>

<div class="form-actions">
  <button type="submit" class="btn btn-primary btn-submit">Submit report</button>
</div>

<div id="formFeedback"></div>
</form>
</div>

<aside class="report-right">
  <div id="map" style="height:300px"></div>
</aside>

</div>
</div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(() => {

  const form = document.getElementById('reportForm');
  const titleEl = document.getElementById('title');
  const descEl = document.getElementById('description');
  const latEl = document.getElementById('lat');
  const lonEl = document.getElementById('lon');
  const severityEl = document.getElementById('severity');
  const photoInput = document.getElementById('photo');
  const feedback = document.getElementById('formFeedback');

  // ✅ FIX-3: Correct coordinate validation
  function isValidLat(v) {
    const n = Number(v);
    return !isNaN(n) && n >= -90 && n <= 90;
  }
  function isValidLon(v) {
    const n = Number(v);
    return !isNaN(n) && n >= -180 && n <= 180;
  }

  // Map
  const map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  let marker;
  map.on('click', e => {
    if (!marker) marker = L.marker(e.latlng).addTo(map);
    else marker.setLatLng(e.latlng);
    latEl.value = e.latlng.lat.toFixed(6);
    lonEl.value = e.latlng.lng.toFixed(6);
  });

  // Submit
  form.addEventListener('submit', async e => {
    e.preventDefault();
    feedback.textContent = '';

    if (!titleEl.value.trim()) return feedback.textContent = 'Title required';
    if (!descEl.value.trim()) return feedback.textContent = 'Description required';
    if (!isValidLat(latEl.value)) return feedback.textContent = 'Invalid latitude';
    if (!isValidLon(lonEl.value)) return feedback.textContent = 'Invalid longitude';

    const fd = new FormData(form);
    fd.set('severity', ['low','medium','high'][severityEl.value]);

    try {
  const resp = await fetch('/api/issues', {
    method: 'POST',
    body: fd
  });

  const data = await resp.json();   // ✅ ALWAYS read JSON

  console.log('API response:', data);

  if (!resp.ok) {
    throw new Error(data.detail || 'Submission failed');
  }

  // ✅ SUCCESS
  formFeedback.textContent = 'Report submitted successfully!';
  formFeedback.className = 'form-feedback success';

  // redirect so user sees result
  setTimeout(() => {
    window.location.href = 'issues.html';
  }, 800);

} catch (err) {
  console.error(err);
  formFeedback.textContent = err.message || 'Server error';
  formFeedback.className = 'form-feedback error';
}

  });

})();
</script>

</body>
</html>
